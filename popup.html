<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ytldr</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-width: 300px;
        }
        label, select, button {
            display: block;
            margin-top: 10px;
            width: 100%;
        }
        #status {
            margin-top: 15px;
            font-size: 0.9em;
            color: green;
        }
    </style>
</head>
<body>
    <h2>ytldr</h2>
    <p>Select which Ollama model you want to use for summarization:</p>

    <label for="model-select">Available Models:</label>
    <select id="model-select">
        <option>Loading…</option>
    </select>

    <button id="save-btn">Save Selection</button>
    <div id="status"></div>

    <script>
    (async () => {
        const statusDiv = document.getElementById('status');
        const selectEl  = document.getElementById('model-select');

        // 1) Read the previously saved model from chrome.storage.local, default to "deepseek-r1:1.5b"
        let currentModel = 'deepseek-r1:1.5b';
        chrome.storage.local.get(['ytldr_selectedModel'], (items) => {
            if (items.ytldr_selectedModel) {
                currentModel = items.ytldr_selectedModel;
            }
            // Once we know currentModel, populate the <select> (below).
            loadModelList(currentModel);
        });

        // 2) Fetch and populate the dropdown with Ollama models
        async function loadModelList(defaultModel) {
            selectEl.innerHTML = '<option>Loading…</option>';
            try {
                const res = await fetch('http://localhost:11434/api/tags');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                console.log('ytldr popup: /api/tags responded with:', data);

                let models = [];
                if (Array.isArray(data.tags)) {
                    models = data.tags.slice();
                } else if (Array.isArray(data.models)) {
                    models = data.models.map(m => m.name);
                } else {
                    console.warn('ytldr popup: unexpected JSON shape (no data.tags or data.models).', data);
                }

                // Clear placeholder
                selectEl.innerHTML = '';

                if (models.length === 0) {
                    const opt = document.createElement('option');
                    opt.textContent = 'No models found';
                    opt.disabled = true;
                    selectEl.appendChild(opt);
                } else {
                    models.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        if (name === defaultModel) opt.selected = true;
                        selectEl.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('ytldr popup: Failed to fetch models from Ollama (/api/tags):', err);
                selectEl.innerHTML = '<option disabled>Error loading models</option>';
                statusDiv.textContent = '⚠️ Could not load model list from Ollama.';
            }
        }

        // 3) “Save Selection” button logic
        document.getElementById('save-btn').addEventListener('click', () => {
            const chosen = selectEl.value;
            if (!chosen || chosen === 'Loading…' || chosen === 'No models found' || chosen.startsWith('Error')) {
                return;
            }
            chrome.storage.local.set({ ytldr_selectedModel: chosen }, () => {
                statusDiv.textContent = `✅ Saved model: ${chosen}`;
                setTimeout(() => { statusDiv.textContent = ''; }, 2000);
            });
        });
    })();
    </script>
</body>
</html>
